#!/usr/bin/env php
<?php

use Symfony\Component\Console\Application;
use ZnLib\Console\Symfony4\Helpers\CommandHelper;
use Illuminate\Container\Container;
use ZnCore\Base\Legacy\Yii\Helpers\ArrayHelper;
use ZnCore\Base\Libs\App\Kernel;
use ZnCore\Base\Libs\App\Loaders\BundleLoader;
use ZnCore\Base\Libs\DotEnv\DotEnv;

require __DIR__ . '/../vendor/autoload.php';

DotEnv::init(__DIR__ . '/..');
$kernel = new Kernel('console');
$container = Container::getInstance();
$kernel->setContainer($container);
$bundles = [
    new \ZnLib\Fixture\Bundle(['container', 'console']),
    new \ZnLib\Db\Bundle(['container', 'console']),
    new \ZnLib\Migration\Bundle(['container', 'console']),
    new \ZnTool\Package\Bundle(['container', 'console']),
    new \ZnTool\Phar\Bundle(['container', 'console']),
];
$bundles = ArrayHelper::merge($bundles, include __DIR__ . '/../' . DotEnv::get('BUNDLES_CONFIG_FILE'));
$bundleLoader = new BundleLoader($bundles, ['i18next', 'container', 'console', 'migration']);
$kernel->setLoader($bundleLoader);
$config = $kernel->loadAppConfig();

$application = $container->get(Application::class);
CommandHelper::registerFromNamespaceList($config['consoleCommands'], $container, $application);
$application->run();
