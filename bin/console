#!/usr/bin/env php
<?php

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Input\InputOption;
use ZnCore\Base\Legacy\Yii\Helpers\ArrayHelper;
use ZnCore\Base\Libs\App\Kernel;
use ZnCore\Base\Libs\App\Loaders\BundleLoader;
use ZnCore\Base\Libs\DotEnv\DotEnv;
use ZnLib\Console\Symfony4\Helpers\CommandHelper;

/**
 * @var Application $application
 */

require __DIR__ . '/../vendor/autoload.php';

$isTest = in_array('--env=test', $argv);
if ($isTest) {
    $_ENV['APP_ENV'] = 'test';
}

DotEnv::init(__DIR__ . '/..');
$bundles = [
    new \ZnLib\Fixture\Bundle(['container', 'console']),
    new \ZnLib\Db\Bundle(['container', 'console']),
    new \ZnLib\Migration\Bundle(['container', 'console']),
    new \ZnTool\Package\Bundle(['container', 'console']),
    new \ZnTool\Phar\Bundle(['container', 'console']),
];
$bundles = ArrayHelper::merge($bundles, include __DIR__ . '/../' . DotEnv::get('BUNDLES_CONFIG_FILE'));
$bundleLoader = new BundleLoader($bundles, ['i18next', 'container', 'console', 'migration']);
$kernel = new Kernel('console');
$kernel->setLoader($bundleLoader);
$config = $kernel->loadAppConfig();

$container = $kernel->getContainer();
$container->bind(Application::class, Application::class, true);
$application = $container->get(Application::class);
$application->getDefinition()->addOptions([
    new InputOption(
        '--env',
        '-e',
        InputOption::VALUE_OPTIONAL,
        'The environment to operate in.',
        'DEV'
    )
]);
CommandHelper::registerFromNamespaceList($config['consoleCommands'], $container, $application);
$application->run();
